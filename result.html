<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>‡πÄ‡∏Å‡∏°‡πÇ‡∏ä‡∏ß‡πå - ‡πÄ‡∏â‡∏•‡∏¢</title>

<!-- ‡∏ü‡∏≠‡∏ô‡∏ï‡πå Mitr -->
<link href="https://fonts.googleapis.com/css2?family=Mitr:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{--accent:#ffd400;--bg:#05245a;}
body{
  margin:0;
  font-family:"Mitr",sans-serif;
  background:linear-gradient(180deg,#04214a,#072e5c);
  color:#fff;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.stage{
  background:rgba(255,255,255,0.05);
  padding:24px;
  border-radius:18px;
  border:5px solid var(--accent);
  max-width:900px;
  width:95%;
}
h1{
  text-align:center;
  color:var(--accent);
  font-weight:600;
}
#checkBtn{
  display:block;
  margin:40px auto 20px auto;
  font-size:24px;
  padding:14px 28px;
  border-radius:12px;
  background:var(--accent);
  color:#05245a;
  border:0;
  cursor:pointer;
  font-weight:700;
}
#status{
  text-align:center;
  color:#cbd5e1;
  font-size:18px;
  margin-top:20px;
  display:none;
}
.results{
  margin-top:30px;
  min-height:100px;
}
.card-result{
  background:rgba(255,255,255,0.06);
  padding:12px 16px;
  border-radius:10px;
  margin-bottom:8px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  animation:show .4s ease both;
}
.rank-badge{
  background:var(--accent);
  color:#05245a;
  padding:6px 12px;
  border-radius:999px;
  font-weight:700;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
}
.notfound{
  background:#3b3b3b;
  color:#fff;
  padding:6px 12px;
  border-radius:8px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
  font-weight:500;
}
@keyframes show{
  from{opacity:0;transform:translateY(8px);}
  to{opacity:1;transform:translateY(0);}
}
.bottom-btns{
  display:flex;
  justify-content:center;
  gap:12px;
  flex-wrap:wrap;
  margin-top:24px;
}
.bottom-btns button{
  font-size:16px;
  padding:10px 16px;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
  border:1px solid rgba(255,255,255,0.2);
  font-family:"Mitr",sans-serif;
}
#backBtn{
  background:#333;
  color:#fff;
}
#resetBtn{
  background:transparent;
  color:#cbd5e1;
}
#backBtn:hover,#resetBtn:hover{
  opacity:0.8;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
  background:rgba(255,255,255,0.06);
  border-radius:10px;
  overflow:hidden;
  font-family:"Mitr",sans-serif;
}
th,td{
  padding:10px;
  text-align:center;
  border-bottom:1px solid rgba(255,255,255,0.1);
}
th{
  background:rgba(255,255,255,0.1);
  color:var(--accent);
  font-weight:600;
}
td:first-child{
  font-weight:600;
}
#downloadBtn{
  display:block;
  margin:20px auto;
  background:var(--accent);
  color:#05245a;
  font-weight:700;
  border:none;
  padding:10px 20px;
  border-radius:10px;
  cursor:pointer;
  font-family:"Mitr",sans-serif;
}
#downloadBtn:hover{
  opacity:0.9;
}
</style>
</head>
<body>
<div class="stage">
  <h1 id="pageTitle">‡πÄ‡∏â‡∏•‡∏¢‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h1>
  <button id="checkBtn">‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
  <div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö...</div>
  <div id="results" class="results"></div>
  <div id="scoreTable"></div>
  <div id="downloadContainer" style="text-align:center;"></div>

  <div class="bottom-btns">
    <button id="backBtn">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
    <button id="resetBtn">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ú‡∏•‡πÄ‡∏â‡∏•‡∏¢</button>
  </div>
</div>

<script>
function wait(ms){return new Promise(res=>setTimeout(res,ms));}
function norm(s){return (s||'').toLowerCase().trim();}
function escapeHtml(s){return s.replace(/[&<>]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]));}

const ranks=(localStorage.getItem('ranks')||'').split('\n').map(v=>v.trim()).filter(Boolean);
const answers=JSON.parse(localStorage.getItem('answers')||'[]');

const btn=document.getElementById('checkBtn');
const statusEl=document.getElementById('status');
const results=document.getElementById('results');
const scoreTable=document.getElementById('scoreTable');
const downloadContainer=document.getElementById('downloadContainer');
const backBtn=document.getElementById('backBtn');
const resetBtn=document.getElementById('resetBtn');
const pageTitle=document.getElementById('pageTitle');

backBtn.addEventListener('click',()=>{
  if(confirm('‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')){
    localStorage.clear();
    location.href='index.html';
  }
});

resetBtn.addEventListener('click',()=>{
  results.innerHTML='';
  scoreTable.innerHTML='';
  downloadContainer.innerHTML='';
  btn.style.display='block';
  results.style.display='block';
  pageTitle.textContent='‡πÄ‡∏â‡∏•‡∏¢‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå';
  pageTitle.style.display='block';
});

btn.addEventListener('click',async()=>{
  if(!ranks.length||!answers.length){
    alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å');
    return;
  }

  btn.style.display='none';
  statusEl.style.display='block';
  await wait(2000);
  statusEl.style.display='none';

  const map=new Map();
  ranks.forEach((r,i)=>map.set(norm(r),i+1));

  let resultData=answers.map((t,i)=>({
    text:t,
    rank:map.get(norm(t))||null,
    group:i+1,
    score:map.get(norm(t))||0
  })).filter(r=>r.text.trim()!=="");

  resultData.sort((a,b)=>{
    if(a.rank===null && b.rank!==null) return -1;
    if(a.rank!==null && b.rank===null) return 1;
    if(a.rank===null && b.rank===null) return a.group - b.group;
    return a.rank - b.rank;
  });

  results.innerHTML='';
  const groupScores = Array(answers.length).fill(0);

  for(const r of resultData){
    groupScores[r.group-1] += r.score;
    const card=document.createElement('div');
    card.className='card-result';
    card.innerHTML=`
      <div>
        <div style="font-size:20px;font-weight:600">${escapeHtml(r.text)}</div>
        <div style="font-size:14px;color:#ccc">
          ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà ${r.group} ‚Äî ${r.rank ? '‡∏û‡∏ö‡πÉ‡∏ô 25 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö' : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô 25 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö'}
        </div>
      </div>
      ${
        r.rank
          ? `<div class="rank-badge">
              <div>‡∏ó‡∏µ‡πà ${r.rank}</div>
              <div style="font-size:13px">+${r.score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
            </div>`
          : `<div class="notfound">
              <div>‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö</div>
              <div style="font-size:13px">+0 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
            </div>`
      }
    `;
    results.appendChild(card);
    await wait(1000);
  }

  await wait(2000);

  results.style.display = 'none';
  pageTitle.style.display = 'none';

  const scoreData = groupScores
    .map((s,i)=>({group:i+1,score:s}))
    .filter(g=>g.score>0);

  scoreData.sort((a,b)=>b.score - a.score || a.group - b.group);

  let tableHTML = `
    <table>
      <thead><tr><th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th></tr></thead>
      <tbody>
  `;
  scoreData.forEach((r,idx)=>{
    tableHTML += `<tr><td>${idx+1}</td><td>${r.group}</td><td>${r.score}</td></tr>`;
  });
  tableHTML += `</tbody></table>`;

  scoreTable.innerHTML = `
    <h2 style="text-align:center;color:var(--accent);margin-top:30px;">üèÜ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô üèÜ</h2>
    ${tableHTML}
  `;

  // ‚úÖ ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á "‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà" ‡πÑ‡∏´‡∏ô
  const gameName = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà 1, ‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà 2, ‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà 3):");
  if (gameName) {
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbznZXKXoB2tTb5SMSNT5IugsOiKj8Opcz9gld8EuccA7Qeq_xDAD-IKXLYAOURR7CXR0g/exec"; // <--- ‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå Web App ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    fetch(SHEET_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        game: gameName,
        scores: scoreData
      })
    }).then(() => {
      alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡∏á Google Sheet ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }).catch(err => {
      alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô");
      console.error(err);
    });
  }

  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå .txt
  const textLines = scoreData.map((r,idx)=>`‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ${idx+1} - ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà ${r.group} : ${r.score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`);
  const blob = new Blob([textLines.join('\n')], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);

  downloadContainer.innerHTML = `<button id="downloadBtn">üìÑ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (.txt)</button>`;
  const downloadBtn = document.getElementById('downloadBtn');
  downloadBtn.addEventListener('click', () => {
    const a = document.createElement('a');
    a.href = url;
    a.download = '‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô.txt';
    a.click();
    URL.revokeObjectURL(url);
  });
});
</script>
</body>
</html>
