<script>
function wait(ms){return new Promise(res=>setTimeout(res,ms));}
function norm(s){return (s||'').toLowerCase().trim();}
function escapeHtml(s){return s.replace(/[&<>]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]));}

const ranks=(localStorage.getItem('ranks')||'').split('\n').map(v=>v.trim()).filter(Boolean);
const answers=JSON.parse(localStorage.getItem('answers')||'[]');

const btn=document.getElementById('checkBtn');
const statusEl=document.getElementById('status');
const results=document.getElementById('results');
const scoreTable=document.getElementById('scoreTable');
const downloadContainer=document.getElementById('downloadContainer');
const saveContainer=document.getElementById('saveContainer');
const saveBtn=document.getElementById('saveBtn');
const gameSelect=document.getElementById('gameSelect');
const backBtn=document.getElementById('backBtn');
const resetBtn=document.getElementById('resetBtn');
const pageTitle=document.getElementById('pageTitle');

backBtn.addEventListener('click',()=>{
  if(confirm('‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')){
    localStorage.clear();
    location.href='index.html';
  }
});
resetBtn.addEventListener('click',()=>{
  results.innerHTML='';
  scoreTable.innerHTML='';
  downloadContainer.innerHTML='';
  saveContainer.style.display='none';
  btn.style.display='block';
  pageTitle.style.display='block';
});

btn.addEventListener('click',async()=>{
  if(!ranks.length||!answers.length){
    alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å');
    return;
  }

  btn.style.display='none';
  statusEl.style.display='block';
  await wait(2000);
  statusEl.style.display='none';

  const map=new Map();
  ranks.forEach((r,i)=>map.set(norm(r),i+1));

  let resultData=answers.map((t,i)=>({
    text:t,
    rank:map.get(norm(t))||null,
    group:i+1,
    score:map.get(norm(t))||0
  })).filter(r=>r.text.trim()!=="");

  resultData.sort((a,b)=>{
    if(a.rank===null && b.rank!==null) return -1;
    if(a.rank!==null && b.rank===null) return 1;
    if(a.rank===null && b.rank===null) return a.group - b.group;
    return a.rank - b.rank;
  });

  results.innerHTML='';
  const groupScores = Array(answers.length).fill(0);

  for(const r of resultData){
    groupScores[r.group-1] += r.score;
    const card=document.createElement('div');
    card.className='card-result';
    card.innerHTML=`
      <div>
        <div style="font-size:20px;font-weight:600">${escapeHtml(r.text)}</div>
        <div style="font-size:14px;color:#ccc">
          ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà ${r.group} ‚Äî ${r.rank ? '‡∏û‡∏ö‡πÉ‡∏ô 25 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö' : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô 25 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö'}
        </div>
      </div>
      ${
        r.rank
          ? `<div class="rank-badge">
              <div>‡∏ó‡∏µ‡πà ${r.rank}</div>
              <div style="font-size:13px">+${r.score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
            </div>`
          : `<div class="notfound">
              <div>‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö</div>
              <div style="font-size:13px">+0 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
            </div>`
      }
    `;
    results.appendChild(card);
    await wait(300);
  }

  // ‚úÖ ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 1.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
  await wait(1500);
  results.style.display='none';
  pageTitle.style.display='none';

  const scoreData = groupScores
    .map((s,i)=>({group:i+1,score:s}))
    .filter(g=>g.score>0)
    .sort((a,b)=>b.score - a.score || a.group - b.group);

  let tableHTML = `
    <table>
      <thead><tr><th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th></tr></thead>
      <tbody>
  `;
  scoreData.forEach((r,idx)=>{
    tableHTML += `<tr><td>${idx+1}</td><td>${r.group}</td><td>${r.score}</td></tr>`;
  });
  tableHTML += `</tbody></table>`;

  scoreTable.innerHTML = `
    <h2 style="text-align:center;color:var(--accent);margin-top:30px;">üèÜ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô üèÜ</h2>
    ${tableHTML}
  `;

  saveContainer.style.display='block';

  // ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå .txt
  const textLines = scoreData.map((r,idx)=>`‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ${idx+1} - ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà ${r.group} : ${r.score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`);
  const blob = new Blob([textLines.join('\n')], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  downloadContainer.innerHTML = `<button id="downloadBtn">üìÑ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (.txt)</button>`;
  document.getElementById('downloadBtn').addEventListener('click', () => {
    const a=document.createElement('a');
    a.href=url;a.download='‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô.txt';
    a.click();
    URL.revokeObjectURL(url);
  });

  saveBtn.addEventListener('click',()=>{
    const gameName=gameSelect.value;
    if(!gameName){alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');return;}
    const SHEET_URL="https://script.google.com/macros/s/AKfycbznZXKXoB2tTb5SMSNT5IugsOiKj8Opcz9gld8EuccA7Qeq_xDAD-IKXLYAOURR7CXR0g/exec";
    fetch(SHEET_URL,{
      method:"POST",
      mode:"no-cors",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({game:gameName,scores:scoreData})
    }).then(()=>{
      alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡∏á Google Sheet ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${gameName})`);
    }).catch(err=>{
      alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô");
      console.error(err);
    });
  });
});
</script>
